#!/usr/bin/env ruby

require_relative "../lib/push_event"
require "octokit"

file_path = ARGV.first

if file_path.nil? || file_path.length == 0
  puts "ERROR: You must specify a file path in the args for this Action."
  exit(1)
end

push_event = PushEvent.new(File.read(ENV.fetch("GITHUB_EVENT_PATH")))

puts push_event.data.inspect

unless push_event.valid?
  puts "ERROR: This Action can only be run as part of a workflow triggered by a push event."
  exit(1)
end

puts "Checking if #{file_path} was modified in this push..."

if push_event.modified?(file_path)
  puts "#{file_path} was modified"

  github = Octokit::Client.new(access_token: ENV["GITHUB_TOKEN"])

  repo = push_event.data["repository"]["full_name"]
  pulls = github.pull_requests(repo, state: "open")

  branch_name = push_event.data["ref"].split("/").last
  pr = pulls.find { |pr| pr["head"]["ref"] == branch_name }

  github.add_comment(repo, pr["number"], "#{file_path} changed!")
else
  puts "#{file_path} was not modified"
end
